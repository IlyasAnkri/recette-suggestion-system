name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip smoke tests'
        required: false
        default: 'false'

jobs:
  deploy-backend:
    name: Deploy Backend Services
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    strategy:
      matrix:
        service:
          - api-gateway
          - recipe-database-service
          - user-profile-service
          - ingredient-matching-service
          - recipe-search-service
          - substitution-engine-service
          - analytics-service
          - config-server
    
    steps:
      - name: Trigger Render Deploy
        run: |
          echo "Deploying ${{ matrix.service }} to Render..."
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_BASE_URL }}/${{ matrix.service }}" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}"
      
      - name: Wait for deployment
        run: |
          echo "Waiting 60 seconds for deployment to complete..."
          sleep 60

  deploy-frontend:
    name: Deploy Frontend to Netlify
    runs-on: ubuntu-latest
    needs: deploy-backend
    
    steps:
      - name: Trigger Netlify Deploy
        run: |
          echo "Deploying frontend to Netlify..."
          curl -X POST "${{ secrets.NETLIFY_BUILD_HOOK_URL }}"
      
      - name: Wait for deployment
        run: |
          echo "Waiting 90 seconds for frontend deployment..."
          sleep 90

  smoke-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: github.event.inputs.skip_tests != 'true'
    
    steps:
      - name: Test API Gateway Health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://recipe-adjuster-api-gateway.onrender.com/actuator/health)
          if [ "$response" != "200" ]; then
            echo "❌ API Gateway health check failed with status $response"
            exit 1
          fi
          echo "✅ API Gateway is healthy"
      
      - name: Test Frontend
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://recipe-adjuster.netlify.app)
          if [ "$response" != "200" ]; then
            echo "❌ Frontend health check failed with status $response"
            exit 1
          fi
          echo "✅ Frontend is accessible"
      
      - name: Test Critical API Endpoints
        run: |
          # Test user profile endpoint
          response=$(curl -s -o /dev/null -w "%{http_code}" https://recipe-adjuster-api-gateway.onrender.com/api/users/health)
          if [ "$response" != "200" ] && [ "$response" != "401" ]; then
            echo "⚠️ User profile endpoint returned $response"
          fi
          
          # Test recipe search endpoint
          response=$(curl -s -o /dev/null -w "%{http_code}" https://recipe-adjuster-api-gateway.onrender.com/api/recipes/health)
          if [ "$response" != "200" ] && [ "$response" != "401" ]; then
            echo "⚠️ Recipe search endpoint returned $response"
          fi
          
          echo "✅ Critical endpoints tested"

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend, smoke-tests]
    if: always()
    
    steps:
      - name: Notify Slack on Success
        if: success()
        run: |
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "✅ Production Deployment Successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Deployment Successful* ✅\n\n*Commit:* ${{ github.sha }}\n*Author:* ${{ github.actor }}\n*Branch:* ${{ github.ref_name }}\n\n<https://recipe-adjuster.netlify.app|View Site> | <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"
                  }
                }
              ]
            }'
      
      - name: Notify Slack on Failure
        if: failure()
        run: |
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "❌ Production Deployment Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Deployment Failed* ❌\n\n*Commit:* ${{ github.sha }}\n*Author:* ${{ github.actor }}\n*Branch:* ${{ github.ref_name }}\n\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"
                  }
                }
              ]
            }'
      
      - name: Create deployment record
        run: |
          echo "Recording deployment..."
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "Commit: ${{ github.sha }}"
          echo "Status: ${{ job.status }}"
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
