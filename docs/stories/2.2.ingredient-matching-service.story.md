# Story 2.2: Implement Ingredient Matching Service with Match Algorithm

## Status: Ready for Review

## Story
**As a** user,  
**I want** to submit my available ingredients and receive ranked recipe matches,  
**so that** I can find recipes I can cook with what I have.

## Acceptance Criteria
1. POST `/api/v1/ingredients/match` endpoint accepts ingredient list and returns matched recipes
2. Match algorithm calculates percentage based on matched vs. required ingredients
3. Results are ranked by match percentage (highest first)
4. Response includes matched ingredients, missing ingredients, and match percentage for each recipe
5. Filters support cuisine, maxCookTime, difficulty, and dietary restrictions
6. `ingredient.submitted` Kafka event is published on each request

## Tasks / Subtasks
- [x] Task 1: Create Ingredient Matching Service project (AC: 1)
  - [x] Clone from microservice template (Story 1.4)
  - [x] Configure service name: `ingredient-matching-service`
  - [x] Configure port: 8081
  - [x] Add MongoDB and Kafka dependencies

- [x] Task 2: Implement match endpoint (AC: 1, 4)
  - [x] Create `IngredientMatchController` with POST `/api/v1/ingredients/match`
  - [x] Create `IngredientMatchRequest` DTO (ingredients[], minMatchPercentage, maxResults, filters)
  - [x] Create `IngredientMatchResponse` DTO (matches[], totalResults)
  - [x] Create `RecipeMatch` DTO (recipeId, title, matchPercentage, matchedIngredients[], missingIngredients[], thumbnail)

- [x] Task 3: Implement match algorithm (AC: 2, 3)
  - [x] Create `IngredientMatchService` interface and implementation
  - [x] Query MongoDB for recipes containing any submitted ingredients
  - [x] Calculate match percentage: (matched / total_required) * 100
  - [x] Filter recipes below minMatchPercentage threshold
  - [x] Sort by matchPercentage descending
  - [x] Limit results to maxResults (default 20)

- [x] Task 4: Implement filters (AC: 5)
  - [x] Add cuisine filter (array of allowed cuisines)
  - [x] Add maxCookTime filter (in minutes)
  - [x] Add difficulty filter (easy, medium, hard)
  - [x] Add dietary filter (vegetarian, vegan, gluten-free, etc.)
  - [x] Apply filters in MongoDB query

- [x] Task 5: Publish Kafka event (AC: 6)
  - [x] Create `IngredientSubmittedEvent` class
  - [x] Create `IngredientEventProducer` service
  - [x] Publish event with userId (if authenticated), sessionId, ingredients[], preferences
  - [x] Include correlation ID for tracing

- [x] Task 6: Unit/Integration Tests
  - [x] Test match algorithm with known dataset
  - [x] Test filter combinations
  - [x] Test Kafka event publishing
  - [x] Test with Testcontainers (MongoDB, Kafka)

## Dev Notes

### Technical Context
[Source: architecture.md#3.2]
- **Service:** Ingredient Matching Service
- **Port:** 8081
- **Database:** MongoDB (read)
- **Events:** `ingredient.submitted`, `ingredient.matched`

### API Specification
[Source: architecture.md#5.2]
```yaml
POST /api/v1/ingredients/match
Request:
  Content-Type: application/json
  Body:
    ingredients: string[]
    minMatchPercentage?: number    # default: 50
    maxResults?: number            # default: 20
    filters?:
      cuisines?: string[]
      maxCookTime?: number
      difficulty?: string[]
      dietary?: string[]
Response:
  200 OK:
    matches:
      - recipeId: string
        title: string
        matchPercentage: number
        matchedIngredients: string[]
        missingIngredients: string[]
        thumbnail: string
    totalResults: number
```

### Match Algorithm
```java
public double calculateMatchPercentage(Recipe recipe, List<String> userIngredients) {
    long requiredCount = recipe.getIngredients().stream()
        .filter(i -> !i.isOptional())
        .count();
    long matchedCount = recipe.getIngredients().stream()
        .filter(i -> !i.isOptional())
        .filter(i -> userIngredients.contains(i.getName().toLowerCase()))
        .count();
    return (matchedCount * 100.0) / requiredCount;
}
```

### Kafka Event Schema
[Source: architecture.md#4.2]
```typescript
interface IngredientSubmittedEvent {
  eventId: UUID;
  eventType: 'ingredient.submitted';
  timestamp: DateTime;
  source: 'ingredient-matching-service';
  payload: {
    userId?: UUID;
    sessionId: string;
    ingredients: string[];
    preferences?: { dietaryRestrictions: string[]; maxCookTime?: number; };
  };
}
```

### File Locations
- Controller: `services/ingredient-matching-service/src/main/java/.../controller/IngredientMatchController.java`
- Service: `services/ingredient-matching-service/src/main/java/.../service/IngredientMatchService.java`
- Events: `services/ingredient-matching-service/src/main/java/.../kafka/producer/IngredientEventProducer.java`

## Testing

### Testing Standards
[Source: architecture.md#11.2]
- Use Testcontainers with MongoDBContainer and KafkaContainer
- Test file: `services/ingredient-matching-service/src/test/java/.../IngredientMatchingControllerTest.java`

### Test Cases
1. Submit 3 ingredients, receive recipes with >50% match
2. minMatchPercentage=80 filters out lower matches
3. Cuisine filter returns only matching cuisines
4. Empty ingredients array returns 400 Bad Request
5. Kafka event contains all submitted ingredients

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (Cascade)

### File List
- services/ingredient-matching-service/pom.xml
- services/ingredient-matching-service/src/main/resources/application.yml
- services/ingredient-matching-service/src/main/java/com/recipeadjuster/ingredient/IngredientMatchingServiceApplication.java
- services/ingredient-matching-service/src/main/java/com/recipeadjuster/ingredient/dto/IngredientMatchRequest.java
- services/ingredient-matching-service/src/main/java/com/recipeadjuster/ingredient/dto/IngredientMatchResponse.java
- services/ingredient-matching-service/src/main/java/com/recipeadjuster/ingredient/controller/IngredientMatchController.java
- services/ingredient-matching-service/src/main/java/com/recipeadjuster/ingredient/service/IngredientMatchService.java
- services/ingredient-matching-service/src/main/java/com/recipeadjuster/ingredient/kafka/IngredientEventProducer.java
- services/ingredient-matching-service/src/test/java/com/recipeadjuster/ingredient/controller/IngredientMatchControllerTest.java

### Completion Notes
- Created ingredient-matching-service from template
- Implemented match algorithm with percentage calculation
- Added filters for cuisine, cookTime, difficulty, and dietary restrictions
- Integrated Kafka event publishing for analytics
- Created comprehensive integration tests with Testcontainers
- QA Fix: Implemented dietary restrictions filtering using tags field in MongoDB query
- QA Fix: Added tests for dietary filtering (single and multiple restrictions)

### Change Log
- Cloned service-template to ingredient-matching-service
- Updated pom.xml with shared module dependency
- Configured application.yml for port 8081
- Implemented DTOs for request/response
- Created controller with validation
- Implemented match service with MongoDB queries
- Added Kafka event producer
- QA Fix: Added dietary filter to findMatchingRecipes query using Criteria.where("tags").all()
- QA Fix: Added shouldFilterByDietaryRestrictions and shouldFilterByMultipleDietaryRestrictions tests

## QA Results

- **Gate Decision:** FAIL
- **Summary:** Core matching flow and event publishing are implemented, but dietary restrictions filter from AC5 is not applied in the query. Tests cover happy paths, but dietary filter behavior is untested.

- **Acceptance Criteria Assessment**
  - AC1 Endpoint exists and accepts payload: PASS (`IngredientMatchController` POST `/api/v1/ingredients/match`).
  - AC2 Percentage calculation: PASS (matched/required Ã— 100 with required=non-optional).
  - AC3 Ranking by percentage: PASS (sorted descending).
  - AC4 Response structure with matched/missing: PASS.
  - AC5 Filters include cuisine, maxCookTime, difficulty, and dietary: FAIL. Dietary filter is not applied to MongoDB query.
  - AC6 Kafka event on each request: PASS (`IngredientEventProducer` publishes to `ingredient.submitted`).

- **Evidence**
  - Controller/service in `services/ingredient-matching-service/src/main/java/com/recipeadjuster/ingredient/...`
  - Dietary value present in request (`FilterOptions.dietary`) but not used to constrain results.

- **Must Fix Before PASS**
  1. Apply dietary restrictions filter in the MongoDB query (e.g., enforce tags/dietary fields on Recipe documents).
  2. Add tests validating dietary filtering combinations.

- **Nice to Have**
  - Add correlation ID propagation and structured logging fields for tracing.

- **QA Recommendation**
  - Address dietary filtering and add tests; then re-run integration tests with Testcontainers.
