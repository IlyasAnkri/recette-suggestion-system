# Story 6.3: Build Moderation Workflow and Admin Endpoints

## Status: Ready for Review

## Story
**As a** moderator,  
**I want** to review and approve community recipes,  
**so that** only quality content is shown to users.

## Acceptance Criteria
1. `isApproved` boolean on Recipe model (default false)
2. GET `/api/v1/admin/recipes/pending` lists pending recipes
3. POST `/api/v1/admin/recipes/{id}/approve` approves recipe
4. POST `/api/v1/admin/recipes/{id}/reject` rejects with feedback
5. Email notification sent on approval/rejection
6. Kafka event published only for approved recipes

## Tasks / Subtasks
- [x] Task 1: Add isApproved field (AC: 1)
  - [x] Add to Recipe schema
  - [x] Default to false on create

- [x] Task 2: List pending recipes (AC: 2)
  - [x] Filter by isApproved=false
  - [x] Sort by createdAt (oldest first)
  - [x] Require MODERATOR role

- [x] Task 3: Approve endpoint (AC: 3)
  - [x] Set isApproved=true
  - [x] Set approvedAt timestamp
  - [x] Require MODERATOR role

- [x] Task 4: Reject endpoint (AC: 4)
  - [x] Accept rejection reason
  - [x] Optionally soft delete
  - [x] Require MODERATOR role

- [ ] Task 5: Email notifications (AC: 5)
  - [ ] Send approval email
  - [ ] Send rejection email with feedback

- [ ] Task 6: Kafka events (AC: 6)
  - [ ] Publish recipe.created on approval
  - [ ] Include recipe metadata

## Dev Notes

### Admin Endpoints
```
GET  /api/v1/admin/recipes/pending
POST /api/v1/admin/recipes/{id}/approve
POST /api/v1/admin/recipes/{id}/reject
```

## Testing

### Test Cases
1. Pending list shows unapproved recipes
2. Approve sets isApproved=true
3. Non-moderator gets 403
4. Kafka event published on approve

## Dev Agent Record

### Agent Model Used
Cascade (Claude 3.7 Sonnet)

### Completion Notes
- ModerationService already existed with core functionality
- AdminController already existed with all required endpoints
- GET /api/v1/admin/recipes/pending - lists unapproved recipes
- POST /api/v1/admin/recipes/{id}/approve - approves recipe + sets timestamp
- POST /api/v1/admin/recipes/{id}/reject - deletes recipe with reason
- Role-based authorization (MODERATOR/ADMIN required)
- 5 unit tests created and passing
- Email notifications (Task 5) deferred - requires email service integration
- Kafka events (Task 6) will be implemented in Story 6.6

### File List
- services/recipe-database-service/src/main/java/com/recipeadjuster/recipedatabase/service/ModerationService.java (already exists)
- services/recipe-database-service/src/main/java/com/recipeadjuster/recipedatabase/controller/AdminController.java (already exists)
- services/recipe-database-service/src/test/java/com/recipeadjuster/recipedatabase/service/ModerationServiceTest.java (created)

### Debug Log
- Core moderation workflow complete
- Email and Kafka integration marked as TODOs in code

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Bob (SM) |
| 2025-12-21 | 1.1 | Moderation workflow implementation complete | James (Dev) |
