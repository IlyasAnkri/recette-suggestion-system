# Story 4.2: Implement User Profile Service with Registration and Login

## Status: Ready for Review

## Story
**As a** user,  
**I want** to register and login to the application,  
**so that** my preferences and saved recipes persist across sessions.

## Acceptance Criteria
1. POST `/api/v1/auth/register` creates new user with email/password
2. POST `/api/v1/auth/login` authenticates user and returns JWT + refresh token
3. Passwords hashed with BCrypt (cost factor 12)
4. JWT tokens use RS256 algorithm with 1-hour expiry
5. Refresh token set as HttpOnly cookie (7-day expiry, SameSite=Strict)
6. Validation errors return 400 with detailed messages

## Tasks / Subtasks
- [x] Task 1: Create User Profile Service project (AC: 1)
  - [x] Clone from microservice template
  - [x] Configure service name: `user-profile-service`
  - [x] Configure port: 8084
  - [x] Add Spring Security, Spring Data JPA, PostgreSQL dependencies

- [x] Task 2: Implement registration endpoint (AC: 1, 3)
  - [x] Create `AuthController` with POST `/api/v1/auth/register`
  - [x] Create `RegisterRequest` DTO (email, password, displayName)
  - [x] Validate email format and password strength
  - [x] Hash password with BCrypt (cost factor 12)
  - [x] Create User and UserPreferences records
  - [x] Return created user (without password)

- [x] Task 3: Implement login endpoint (AC: 2, 4, 5)
  - [x] Create POST `/api/v1/auth/login` endpoint
  - [x] Create `LoginRequest` DTO (email, password)
  - [x] Verify password with BCrypt
  - [x] Generate JWT token (RS256, 1-hour expiry)
  - [x] Generate refresh token (64 chars, 7-day expiry)
  - [x] Set refresh token as HttpOnly cookie

- [x] Task 4: Implement JWT token generation (AC: 4)
  - [x] Generate RS256 key pair
  - [x] Create `JwtService` class
  - [x] Include claims: sub (userId), email, roles, iat, exp
  - [x] Sign with private key
  - [x] Store public key for gateway verification

- [x] Task 5: Implement refresh token storage (AC: 5)
  - [x] Create RefreshToken entity
  - [x] Store token hash, userId, expiry in PostgreSQL
  - [x] Implement token rotation on use

- [x] Task 6: Implement validation (AC: 6)
  - [x] Email format validation
  - [x] Password strength (min 8 chars, 1 number, 1 special)
  - [x] Duplicate email check (409 Conflict)
  - [x] Return detailed error messages

## Dev Notes

### API Specification
[Source: architecture.md#5.2]
```yaml
POST /api/v1/auth/register
Request:
  email: string
  password: string
  displayName: string
Response:
  201 Created:
    id: string
    email: string
    displayName: string
    createdAt: string

POST /api/v1/auth/login
Request:
  email: string
  password: string
Response:
  200 OK:
    accessToken: string
    tokenType: "Bearer"
    expiresIn: 3600
  Set-Cookie: refreshToken=...; HttpOnly; Secure; SameSite=Strict; Max-Age=604800
```

### JWT Structure
[Source: architecture.md#10.2]
```json
{
  "header": { "alg": "RS256", "typ": "JWT" },
  "payload": {
    "sub": "user-uuid",
    "email": "user@example.com",
    "roles": ["user"],
    "iat": 1703001234,
    "exp": 1703004834
  }
}
```

### BCrypt Configuration
```java
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder(12);
}
```

### File Locations
- Controller: `services/user-profile-service/src/main/java/.../controller/AuthController.java`
- Service: `services/user-profile-service/src/main/java/.../service/AuthService.java`
- JWT Service: `services/user-profile-service/src/main/java/.../security/JwtService.java`

## Testing

### Test Cases
1. Register with valid data returns 201 and user
2. Register with duplicate email returns 409
3. Login with valid credentials returns JWT
4. Login with wrong password returns 401
5. Password is hashed (not stored plain text)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used
Claude 3.7 Sonnet (Cascade)

### Completion Notes
- Implemented complete authentication flow with registration and login
- Created JwtService with RS256 algorithm for secure token generation
- Implemented BCrypt password hashing with cost factor 12
- Created RefreshToken entity with SHA-256 hashing for secure storage
- Implemented comprehensive validation with Jakarta Validation annotations
- Created AuthService with transactional user registration
- Implemented AuthController with proper HTTP status codes
- Added GlobalExceptionHandler for validation and error responses
- Created comprehensive integration tests with Testcontainers
- Configured Spring Security with stateless session management
- HttpOnly cookies configured for refresh tokens with SameSite=Strict

### File List
- services/user-profile-service/src/main/java/com/recipeadjuster/userprofile/controller/AuthController.java
- services/user-profile-service/src/main/java/com/recipeadjuster/userprofile/service/AuthService.java
- services/user-profile-service/src/main/java/com/recipeadjuster/userprofile/security/JwtService.java
- services/user-profile-service/src/main/java/com/recipeadjuster/userprofile/model/entity/RefreshToken.java
- services/user-profile-service/src/main/java/com/recipeadjuster/userprofile/repository/RefreshTokenRepository.java
- services/user-profile-service/src/main/java/com/recipeadjuster/userprofile/model/dto/RegisterRequest.java
- services/user-profile-service/src/main/java/com/recipeadjuster/userprofile/model/dto/LoginRequest.java
- services/user-profile-service/src/main/java/com/recipeadjuster/userprofile/model/dto/UserResponse.java
- services/user-profile-service/src/main/java/com/recipeadjuster/userprofile/model/dto/LoginResponse.java
- services/user-profile-service/src/main/java/com/recipeadjuster/userprofile/config/SecurityConfig.java
- services/user-profile-service/src/main/java/com/recipeadjuster/userprofile/exception/GlobalExceptionHandler.java
- services/user-profile-service/src/main/resources/db/migration/V2__create_refresh_tokens_table.sql
- services/user-profile-service/src/test/java/com/recipeadjuster/userprofile/controller/AuthControllerTest.java

### Change Log
| Date | Change | Files |
|------|--------|-------|
| 2025-12-21 | Implemented registration and login endpoints | AuthController, AuthService |
| 2025-12-21 | Created JWT service with RS256 signing | JwtService |
| 2025-12-21 | Implemented refresh token storage | RefreshToken, RefreshTokenRepository, V2 migration |
| 2025-12-21 | Added validation and error handling | RegisterRequest, LoginRequest, GlobalExceptionHandler |
| 2025-12-21 | Created integration tests | AuthControllerTest |

## QA Results

### Review Date: 2025-12-21

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The User Profile Service implementation is robust and follows security best practices. The use of BCrypt for password hashing and RS256 for JWT signing ensures strong security. The separation of concerns between Controller, Service, and Repository layers is well-maintained. The integration tests cover both happy paths and edge cases (duplicate email, weak password), providing high confidence in the implementation.

### Compliance Check

- Coding Standards: [✓] DTOs used for API contracts, entities for persistence.
- Project Structure: [✓] Standard Spring Boot layered architecture.
- Testing Strategy: [✓] Testcontainers used for realistic database testing.
- All ACs Met: [✓] Registration, Login, Token generation, and Validation implemented.

### Gate Status

Gate: PASS → docs/qa/gates/4.2-user-profile-service.yml

### Recommended Status

[✓ Ready for Done]

