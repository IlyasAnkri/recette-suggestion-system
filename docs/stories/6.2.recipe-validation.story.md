# Story 6.2: Implement Recipe Validation and Duplicate Detection

## Status: Ready for Review

## Story
**As a** moderator,  
**I want** recipes validated before submission,  
**so that** only quality content enters the database.

## Acceptance Criteria
1. Recipe schema validated (title, ingredients, instructions required)
2. Ingredient IDs verified against ingredient collection
3. Duplicate recipes detected (fuzzy match on title + ingredients)
4. Image URLs validated (HTTPS, valid format)
5. Prep/cook times validated (positive integers)
6. Detailed validation errors returned (400 with error list)

## Tasks / Subtasks
- [x] Task 1: Schema validation (AC: 1)
  - [x] Required field checks
  - [x] Field type validation
  - [x] Length constraints

- [x] Task 2: Ingredient verification (AC: 2)
  - [x] Check ingredient IDs exist
  - [x] Flag unknown ingredients

- [x] Task 3: Duplicate detection (AC: 3)
  - [x] Fuzzy match on title (Levenshtein < 3)
  - [x] Ingredient overlap >80%
  - [x] Return 409 for duplicates

- [x] Task 4: Image validation (AC: 4)
  - [x] HTTPS required
  - [x] Valid image extensions

- [x] Task 5: Time validation (AC: 5)
  - [x] Positive integers only
  - [x] Reasonable limits

- [x] Task 6: Error responses (AC: 6)
  - [x] Collect all validation errors
  - [x] Return detailed error list

## Dev Notes

### Validation Response
```json
{
  "status": 400,
  "errors": [
    {"field": "title", "message": "Title is required"},
    {"field": "ingredients", "message": "At least 2 ingredients required"}
  ]
}
```

## Testing

### Test Cases
1. Missing title returns 400
2. Invalid ingredient ID flagged
3. Duplicate recipe returns 409
4. Invalid image URL rejected

## Dev Agent Record

### Agent Model Used
Cascade (Claude 3.7 Sonnet)

### Completion Notes
- RecipeValidationService created with comprehensive validation
- Schema validation: required fields, length constraints
- Image URL validation: HTTPS + valid formats (jpg, jpeg, png, webp)
- Time validation: positive integers with reasonable limits
- Duplicate detection: Levenshtein distance + ingredient overlap
- Integrated into RecipeController POST endpoint
- Returns 400 with detailed error list on validation failure
- 11 unit tests created and passing

### File List
- services/recipe-database-service/src/main/java/com/recipeadjuster/recipedatabase/model/Recipe.java (created)
- services/recipe-database-service/src/main/java/com/recipeadjuster/recipedatabase/service/RecipeValidationService.java (created)
- services/recipe-database-service/src/main/java/com/recipeadjuster/recipedatabase/controller/RecipeController.java (updated)
- services/recipe-database-service/src/test/java/com/recipeadjuster/recipedatabase/service/RecipeValidationServiceTest.java (created)
- services/recipe-database-service/src/test/java/com/recipeadjuster/recipedatabase/controller/RecipeControllerTest.java (fixed type errors)

### Debug Log
- Fixed RecipeIngredient quantity type from String to Double in existing tests
- Removed unnecessary Mockito stubbings for cleaner tests

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Bob (SM) |
| 2025-12-21 | 1.1 | Validation implementation complete | James (Dev) |
