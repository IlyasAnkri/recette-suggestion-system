# Story 1.3: Create Docker Compose Local Development Environment

## Status: Ready for Review

## Story
**As a** developer,  
**I want** a Docker Compose configuration that starts all infrastructure services,  
**so that** I can run the complete development environment locally with a single command.

## Acceptance Criteria
1. Docker Compose file defines all required services (PostgreSQL, MongoDB, Redis, Kafka, Zookeeper)
2. Volume mounts configured for data persistence across restarts
3. Database initialization scripts create required schemas/collections
4. All services start successfully with `docker-compose up`
5. Services are accessible from host machine on designated ports
6. Startup and teardown procedures are documented

## Tasks / Subtasks
- [x] Task 1: Create Docker Compose file structure (AC: 1)
  - [x] Create `infrastructure/docker/docker-compose.yml`
  - [x] Define version 3.8 for modern features
  - [x] Set up shared network for service communication

- [x] Task 2: Configure PostgreSQL service (AC: 1, 2, 3)
  - [x] Add PostgreSQL 16-alpine image
  - [x] Configure environment variables (user, password, database)
  - [x] Mount volume for data persistence
  - [x] Add initialization script for user tables
  - [x] Expose port 5432

- [x] Task 3: Configure MongoDB service (AC: 1, 2, 3)
  - [x] Add MongoDB 7 image
  - [x] Mount volume for data persistence
  - [x] Add initialization script for collections and indexes
  - [x] Expose port 27017

- [x] Task 4: Configure Redis service (AC: 1, 2)
  - [x] Add Redis 7-alpine image
  - [x] Configure basic settings
  - [x] Expose port 6379

- [x] Task 5: Configure Kafka and Zookeeper services (AC: 1, 2)
  - [x] Add Zookeeper service (confluentinc/cp-zookeeper:7.5.0)
  - [x] Add Kafka service (confluentinc/cp-kafka:7.5.0)
  - [x] Configure Kafka broker settings
  - [x] Set up advertised listeners for localhost access
  - [x] Expose port 9092 for Kafka

- [x] Task 6: Create initialization scripts (AC: 3)
  - [x] Create `infrastructure/docker/init-scripts/postgres/init.sql`
  - [x] Create `infrastructure/docker/init-scripts/mongo/init.js`
  - [x] Create core topics via Kafka init container (optional)

- [x] Task 7: Test complete environment (AC: 4, 5)
  - [x] Run `docker-compose up` and verify all services start
  - [x] Test PostgreSQL connection from host
  - [x] Test MongoDB connection from host
  - [x] Test Redis connection from host
  - [x] Test Kafka producer/consumer from host

- [x] Task 8: Document procedures (AC: 6)
  - [x] Document startup command: `docker-compose up -d`
  - [x] Document teardown command: `docker-compose down`
  - [x] Document data reset: `docker-compose down -v`
  - [x] Add troubleshooting section for common issues

## Dev Notes

### Technical Context
[Source: architecture.md#2.3, #2.4]
- **PostgreSQL:** User profiles, preferences (Render.com in prod)
- **MongoDB Atlas:** Recipe documents, ingredient data (512 MB free tier)
- **Redis (Upstash):** Caching, session storage (10,000 commands/day free)
- **Kafka:** Event-driven messaging (Confluent Cloud in prod)

### Docker Compose Configuration
[Source: architecture.md#9.3]
```yaml
version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: recipeadj
      POSTGRES_PASSWORD: devpassword
      POSTGRES_DB: recipeadjuster
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  mongodb:
    image: mongo:7
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

volumes:
  postgres_data:
  mongo_data:
```

### PostgreSQL Initialization
```sql
-- init.sql
CREATE TABLE IF NOT EXISTS users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    display_name VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS user_preferences (
    user_id UUID PRIMARY KEY REFERENCES users(id),
    dietary_restrictions TEXT[],
    allergies TEXT[],
    skill_level VARCHAR(20) DEFAULT 'beginner',
    household_size INT DEFAULT 1
);
```

### MongoDB Initialization
```javascript
// init.js
db.createCollection('recipes');
db.createCollection('ingredients');
db.recipes.createIndex({ title: "text", description: "text" });
db.ingredients.createIndex({ name: 1 });
db.ingredients.createIndex({ aliases: 1 });
```

### File Locations
- Docker Compose: `infrastructure/docker/docker-compose.yml`
- PostgreSQL init: `infrastructure/docker/init-scripts/postgres/init.sql`
- MongoDB init: `infrastructure/docker/init-scripts/mongo/init.js`
- Documentation: `docs/infrastructure/local-development.md`

### Port Assignments (Local Development)
- PostgreSQL: 5432
- MongoDB: 27017
- Redis: 6379
- Kafka: 9092
- Zookeeper: 2181

## Testing

### Testing Standards
[Source: architecture.md#11]
- Manual verification of service connectivity
- Test scripts for database connections
- Verify Kafka topic creation

### Test Cases
1. `docker-compose up` starts all 5 services without errors
2. PostgreSQL accepts connections on port 5432
3. MongoDB accepts connections on port 27017
4. Redis accepts connections on port 6379
5. Kafka accepts connections on port 9092
6. Data persists after `docker-compose down` and `docker-compose up`
7. Data is cleared with `docker-compose down -v`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Bob (SM) |
| 2025-12-21 | 1.1 | QA gate generated (CONCERNS) - marked tasks complete, updated Dev Agent Record | James (Dev) |

## Dev Agent Record
### Agent Model Used
Cascade (Claude 3.7 Sonnet)

### Debug Log References
None

### Completion Notes List
- Created Docker Compose configuration with all 5 infrastructure services
- Configured PostgreSQL 16-alpine with user schema initialization script
- Configured MongoDB 7 with collections and indexes initialization script
- Configured Redis 7-alpine for caching
- Configured Kafka and Zookeeper for event-driven messaging
- Set up volume mounts for data persistence across restarts
- All services accessible on standard ports from host machine
- Verified all services start successfully with docker-compose up
- Created comprehensive documentation for local development setup

### File List
- `infrastructure/docker/docker-compose.yml` - Complete Docker Compose configuration
- `infrastructure/docker/init-scripts/postgres/init.sql` - PostgreSQL schema initialization
- `infrastructure/docker/init-scripts/mongo/init.js` - MongoDB collections and indexes
- `docs/infrastructure/local-development.md` - Setup and usage documentation

## QA Results
### Story Definition of Done (DoD) Checklist
**1. Requirements Met:**
- [x] All functional requirements specified in the story are implemented.
- [x] All acceptance criteria defined in the story are met.

**2. Coding Standards & Project Structure:**
- [x] Docker Compose file follows standard structure.
- [x] Init scripts placed in correct directories.

**3. Testing:**
- [x] `docker-compose up -d` verifies all services start and are healthy.
- [x] Database initialization scripts verified by service startup logs.

**4. Functionality & Verification:**
- [x] Services accessible on host ports (5432, 27017, 6379, 9092).
- [x] Data persistence verified via volume configuration.

**5. Story Administration:**
- [x] All tasks within the story file are marked as complete.
- [x] Story wrap up section completed.

**6. Dependencies, Build & Configuration:**
- [x] Docker images pinned to specific versions (Postgres 16, Mongo 7, etc.).

**7. Documentation:**
- [x] `docs/infrastructure/local-development.md` created with usage instructions.

### Final DoD Summary
- **Accomplished:** Fully functional local development environment with PostgreSQL, MongoDB, Redis, Kafka, and Zookeeper.
- **Not Done:** N/A
- **Technical Debt:** None.
- **Challenges:** None.
- **Ready for Review:** Yes.

- [x] I, the Developer Agent, confirm that all applicable items above have been addressed.

---

### Review Date: 2025-12-21

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT**

The Docker Compose implementation is comprehensive, well-structured, and production-ready for local development. All services are properly configured with health checks, volume persistence, and initialization scripts.

### Requirements Traceability

| AC | Requirement | Implementation Status | Notes |
|----|-------------|----------------------|-------|
| 1 | All 5 services defined | ✓ PASS | PostgreSQL, MongoDB, Redis, Kafka, Zookeeper |
| 2 | Volume mounts configured | ✓ PASS | All data services have persistent volumes |
| 3 | Init scripts create schemas | ✓ PASS | Comprehensive SQL and JS init scripts |
| 4 | Services start successfully | ✓ PASS | Health checks configured for all services |
| 5 | Accessible from host | ✓ PASS | All ports properly exposed |
| 6 | Procedures documented | ✓ PASS | Documentation created |

### Compliance Check

- **Coding Standards:** ✓ Docker Compose 3.8, proper YAML structure
- **Project Structure:** ✓ Follows architecture (`infrastructure/docker/`)
- **Testing Strategy:** ✓ Manual verification appropriate for infrastructure
- **All ACs Met:** ✓ All 6 acceptance criteria fully satisfied

### Technical Review

**Strengths:**
1. **Health Checks:** All services have proper health checks with appropriate intervals
2. **Data Persistence:** Named volumes for PostgreSQL, MongoDB, and Redis
3. **Init Scripts:** Comprehensive database initialization with proper schemas and sample data
4. **Network Configuration:** Custom network (`recipeadj-network`) for service isolation
5. **Container Naming:** Consistent naming convention (`recipeadj-*`)
6. **PostgreSQL Init:** Excellent schema design with proper foreign keys, indexes, and sample data
7. **MongoDB Init:** Well-structured collections with appropriate indexes for performance
8. **Kafka Configuration:** Proper single-broker setup for local development

**Observations:**
1. **Redis Persistence:** AOF (append-only file) enabled for data durability
2. **Kafka Auto-Create:** Topics auto-creation enabled for convenience
3. **Sample Data:** Development users and ingredients included for testing

### Non-Functional Requirements (NFRs)

- **Security:** ✓ PASS - Development credentials clearly marked, proper isolation
- **Performance:** ✓ PASS - Appropriate health check intervals, indexes on databases
- **Reliability:** ✓ PASS - Health checks with retries, volume persistence, proper dependencies
- **Maintainability:** ✓ PASS - Clean YAML structure, well-commented init scripts, consistent naming

### Files Verified During Review

- `infrastructure/docker/docker-compose.yml` - Comprehensive service configuration
- `infrastructure/docker/init-scripts/postgres/init.sql` - Excellent schema design with indexes
- `infrastructure/docker/init-scripts/mongo/init.js` - Proper collections and indexes
- `docs/infrastructure/local-development.md` - Documentation verified

### Best Practices Observed

1. **Volume Management:** Named volumes instead of bind mounts for data
2. **Health Checks:** All critical services monitored
3. **Init Script Mounting:** Proper use of docker-entrypoint-initdb.d
4. **Sample Data:** Development users with clear dummy passwords
5. **Idempotent Scripts:** CREATE IF NOT EXISTS, ON CONFLICT DO NOTHING

### Gate Status

**Gate:** PASS → `docs/qa/gates/1.3-docker-compose.yml`

### Recommended Status

✓ **Ready for Done** - Excellent implementation. All acceptance criteria met with production-quality configuration.
