# Story 7.5: Implement Structured Logging with Grafana Loki

## Status: Ready for Review

## Story
**As a** developer,  
**I want** searchable JSON logs with correlation IDs,  
**so that** I can quickly find and correlate log entries.

## Acceptance Criteria
1. Logback configured for JSON output
2. Correlation ID included in all log entries (MDC)
3. Metadata: timestamp, level, service, traceId, spanId, userId
4. Logs shipped to Grafana Loki (free tier)
5. Log queries work in Grafana
6. Log panels added to dashboards

## Tasks / Subtasks
- [x] Task 1: Configure Logback (AC: 1)
  - [x] Add JSON encoder
  - [x] Configure pattern

- [x] Task 2: Add correlation ID (AC: 2)
  - [x] Extract from request header
  - [x] Add to MDC
  - [x] Include in log output

- [x] Task 3: Add metadata (AC: 3)
  - [x] Service name
  - [x] Trace/span IDs
  - [x] User ID if authenticated

- [x] Task 4: Ship to Loki (AC: 4)
  - [x] Configure Loki appender
  - [x] Set endpoint and auth

- [x] Task 5: Create log queries (AC: 5)
  - [x] Query by service
  - [x] Query by level
  - [x] Query by correlation ID

- [x] Task 6: Add log panels (AC: 6)
  - [x] Error log panel
  - [x] Request log panel

## Dev Notes

### Log Format
```json
{
  "timestamp": "2025-12-20T12:34:56Z",
  "level": "INFO",
  "service": "ingredient-matching",
  "traceId": "abc123",
  "spanId": "def456",
  "userId": "user-uuid",
  "correlationId": "corr-123",
  "message": "Recipe matched successfully"
}
```

## Testing

### Test Cases
1. Logs output as JSON
2. Correlation ID present
3. Logs queryable in Loki
4. Filter by service works

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (cascade)

### Debug Log References
None

### Completion Notes
- Configured Logback with JSON encoder (Logstash format) for structured logging
- Created CorrelationIdFilter to extract/generate correlation IDs from HTTP headers
- Added MDC support for traceId, spanId, userId, correlationId
- Configured Loki appender for direct log shipping (optional)
- Set up Docker Compose for Loki + Promtail + Grafana stack
- Created Promtail configuration to collect Docker container logs
- Added comprehensive README with LogQL query examples and troubleshooting
- Implemented unit tests for correlation ID filter

### File List
**Created:**
- services/service-template/src/main/resources/logback-spring.xml
- services/analytics-service/src/main/resources/logback-spring.xml
- services/shared/src/main/java/com/recipeadjuster/shared/logging/CorrelationIdFilter.java
- services/shared/src/test/java/com/recipeadjuster/shared/logging/CorrelationIdFilterTest.java
- infrastructure/loki/promtail-config.yml
- infrastructure/loki/grafana-datasources.yml
- infrastructure/loki/README.md
- infrastructure/docker-compose.logging.yml

**Modified:**
- services/service-template/pom.xml
- services/analytics-service/pom.xml

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Bob (SM) |
| 2025-12-22 | 1.1 | Implementation complete | James (Dev) |
