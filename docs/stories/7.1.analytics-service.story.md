# Story 7.1: Implement Analytics Service with Kafka Event Consumption

## Status: Ready for Review

## Story
**As a** product owner,  
**I want** all user activity tracked and aggregated,  
**so that** I can understand usage patterns and make data-driven decisions.

## Acceptance Criteria
1. Analytics Service consumes all Kafka events
2. Aggregated data stored in PostgreSQL (DAU, searches, substitutions)
3. Scheduled jobs run daily aggregation at midnight UTC
4. GET `/api/v1/analytics/dashboard` returns summary stats
5. GET `/api/v1/analytics/recipes/popular` returns top recipes
6. Admin role required for analytics endpoints

## Tasks / Subtasks
- [x] Task 1: Create Analytics Service (AC: 1)
  - [x] Clone from microservice template
  - [x] Configure service name: `analytics-service`
  - [x] Configure port: 8086

- [x] Task 2: Create Kafka consumers (AC: 1)
  - [x] Consume ingredient.submitted
  - [x] Consume recipe.matched
  - [x] Consume substitution.completed
  - [x] Consume user.preference.updated

- [x] Task 3: Define aggregation tables (AC: 2)
  - [x] daily_active_users
  - [x] daily_searches
  - [x] popular_recipes
  - [x] substitution_stats

- [x] Task 4: Implement aggregation jobs (AC: 3)
  - [x] Scheduled job at midnight UTC
  - [x] Aggregate previous day's events
  - [x] Store in summary tables

- [x] Task 5: Create dashboard endpoint (AC: 4)
  - [x] Return DAU, total searches, etc.
  - [x] Support date range filter

- [x] Task 6: Create popular recipes endpoint (AC: 5)
  - [x] Return top 10 by views
  - [x] Include view counts

## Dev Notes

### Aggregation Tables
```sql
CREATE TABLE daily_active_users (
  date DATE PRIMARY KEY,
  count INT
);

CREATE TABLE daily_searches (
  date DATE PRIMARY KEY,
  count INT,
  avg_ingredients_per_search DECIMAL
);
```

## Testing

### Test Cases
1. Kafka events consumed correctly
2. Daily aggregation runs
3. Dashboard returns stats
4. Non-admin gets 403

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (cascade)

### Debug Log References
None

### Completion Notes
- Created analytics-service from template
- Implemented Kafka event consumers for all event types
- Created PostgreSQL aggregation tables with Flyway migration
- Implemented scheduled aggregation job running at midnight UTC
- Created dashboard and popular recipes endpoints with admin security
- Added comprehensive unit tests for consumers, services, and controllers
- Created shared event classes: RecipeMatchedEvent, SubstitutionCompletedEvent, UserPreferenceUpdatedEvent

### File List
**Created:**
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/AnalyticsServiceApplication.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/model/entity/DailyActiveUsers.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/model/entity/DailySearches.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/model/entity/PopularRecipe.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/model/entity/SubstitutionStats.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/model/entity/EventTracking.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/repository/DailyActiveUsersRepository.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/repository/DailySearchesRepository.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/repository/PopularRecipeRepository.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/repository/SubstitutionStatsRepository.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/repository/EventTrackingRepository.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/model/dto/DashboardResponse.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/model/dto/PopularRecipeResponse.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/consumer/AnalyticsEventConsumer.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/service/EventTrackingService.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/service/AggregationService.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/service/AnalyticsService.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/controller/AnalyticsController.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/config/SecurityConfig.java
- services/analytics-service/src/main/java/com/recipeadjuster/analytics/config/KafkaConfig.java
- services/analytics-service/src/main/resources/db/migration/V1__create_analytics_tables.sql
- services/analytics-service/src/test/java/com/recipeadjuster/analytics/consumer/AnalyticsEventConsumerTest.java
- services/analytics-service/src/test/java/com/recipeadjuster/analytics/controller/AnalyticsControllerTest.java
- services/analytics-service/src/test/java/com/recipeadjuster/analytics/service/AggregationServiceTest.java
- services/shared/src/main/java/com/recipeadjuster/shared/event/RecipeMatchedEvent.java
- services/shared/src/main/java/com/recipeadjuster/shared/event/SubstitutionCompletedEvent.java
- services/shared/src/main/java/com/recipeadjuster/shared/event/UserPreferenceUpdatedEvent.java

**Modified:**
- services/analytics-service/pom.xml
- services/analytics-service/src/main/resources/application.yml

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Bob (SM) |
| 2025-12-22 | 1.1 | Implementation complete | James (Dev) |
