server:
  port: 8080

spring:
  application:
    name: api-gateway

eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_SERVER_URL:http://localhost:8761/eureka/}
    register-with-eureka: true
    fetch-registry: true
  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${random.value}

spring:
  cloud:
    gateway:
      routes:
        # Ingredient Matching Service
        - id: ingredient-matching
          uri: lb://ingredient-matching-service
          predicates:
            - Path=/api/v1/ingredients/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20

        # Recipe Search Service
        - id: recipe-search
          uri: lb://recipe-search-service
          predicates:
            - Path=/api/v1/recipes/search/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20

        # Substitution Engine Service
        - id: substitution-engine
          uri: lb://substitution-engine-service
          predicates:
            - Path=/api/v1/substitutions/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
            - name: CircuitBreaker
              args:
                name: substitutionCB
                fallbackUri: forward:/fallback/substitutions

        # User Profile Service
        - id: user-profile
          uri: lb://user-profile-service
          predicates:
            - Path=/api/v1/users/**,/api/v1/auth/**

        # Recipe Database Service (CRUD)
        - id: recipe-database
          uri: lb://recipe-database-service
          predicates:
            - Path=/api/v1/recipes/manage/**

        # Analytics Service
        - id: analytics
          uri: lb://analytics-service
          predicates:
            - Path=/api/v1/analytics/**

      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin
        - AddResponseHeader=X-Response-Time, ${response_time}ms

  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}

  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${JWT_ISSUER_URI:http://localhost:8084}

management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus
  endpoint:
    health:
      show-details: when_authorized

jwt:
  public-key: "${JWT_PUBLIC_KEY:-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvoOhYEEL3wzQqp08lSjH\nbGy2WzyQsKgqgikhakjcI3FPo3adyfkyfHaSdPRY45/dIv/OXVHXEQYOXDLnDpJa\njC4TkEtMcf/rcA/lYFVHBVTYyu55lrW6c9VA1QeJYLns5G9nhwMnuui4LHrM5qms\nmRSFEIpbfdyjEyJXAFruWNIYIbNiFk2MC9utQpEayJ1JV2meya1nQENr+IEOa7cT\nnpFKab3JtrdOB3ezsIjguAQ69NbEpUwFVqaYeij4jOH9fp1IFgPW0M7iLFmjXzpX\nM+mcMQoQ0d0uCS/wg1ujw82iXuhWPdhBXA94j4C0hUd0RfHuYJk/E7Q3xLWMWS92\n6QIDAQAB\n-----END PUBLIC KEY-----}"
  expiration: 3600000

cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:4200,https://recipe-adjuster.netlify.app}
  allowed-methods: GET,POST,PUT,DELETE,OPTIONS,PATCH
  allowed-headers: "*"
  allow-credentials: true
